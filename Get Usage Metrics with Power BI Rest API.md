# Introduction

Power BI provides an opportunity to monitor usage metrics of dashboards and reports to track how they're used in your organization. 
However, the native usage metrics datasets provide limited functionality, e.g. there's no way to get usage metrics across all workspaces in one page.
To make usage metrics reports more flexible it's better to extract this data using a Power BI Rest API solution which is not straightforward and involves a lot of moving parts to make it work properly.
In this guide I'll be showing how to create a stable usage metric solution and how to make it work.
The whole process will be broken into the following sections:

1. Overwiew and how it works
2. Giving permissions to a user and setting up a Service Principal
3. Giving permissions to the Service Principal on Power BI side
4. Setting up a token
5. Getting data from edpoints
6. Extracting the data

#  Overwiew and how it works

* First, create a custom application that will be requesting the data on our behalf - [Service Principal](https://learn.microsoft.com/en-us/power-bi/developer/embedded/embed-service-principal?tabs=azure-portal).

* Then, give your Service Principal access to Microsoft Fabric portal and workspaces where you need to get the usage metrics from.

* Finally, use the token generated by your Service Principal to access the usage metrics data. 

* The hierarchy of in usage metrics data looks like: workspace -> usage metrics report -> table. To get the usage metrics data the workspace id, the report id and the table name is required.
 
* Use this [playground](https://learn.microsoft.com/en-us/rest/api/power-bi/apps/get-app#code-try-0) to see how endpoints work.

# Giving permissions to a user and setting up a Service Principal

First, create a Service Principal in [this portal](https://portal.azure.com/#home) following these steps:

1.	In the search bar above enter “app registrations” and click on the service when it pops up.
2.	Click on “New Registration” and enter a distinctive name in the “Name” section. You will be redirected to Overview page.
3.	Under “Manage” section on the left pane go to “Certificates and secretes” -> “Client secrets” section -> “New client secret”. In a new window set an expiration date and click “Add” to create a secret.
> ❗❗❗WARNING!  The secret will be provided only once and can’t be retrieved in any way once you leave the page. Copy the secret and store it in a safe place before leaving this page!
4.	Under “Manage” section go to “API Permissions” -> “Add a permission” -> “Power BI Service” -> “Delegated permissions".
5.	In “Request API Permissions” select permissions you need for a desired endpoint. For the usage metrics it’s crucial to have Tenant.Read.All and Tenant.ReadWrite.All permissions which require consent from a Global Admin for this Service Principal. 
6.	Go to Azure portal, enter “groups” in the search bar, click on the service, then click on “New group”, you will be redirected to New Group page. 
7.	Enter the Group Name, make sure the Group Type is “Security” then under “Members” click on “No members selected”, add the service principal in “Add Members” window, click on “Select”, click on “Create”. The new security group will be created after some time.

Check this [instruction](https://prodata.ie/2023/11/15/service-principal-fabric) for a visualized guidance.
